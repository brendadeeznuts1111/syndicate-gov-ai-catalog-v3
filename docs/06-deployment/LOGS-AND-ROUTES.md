# 📊 Logs & Routes Documentation

**Runtime logging and API routing infrastructure**

---

## 📋 **Table of Contents**

- [📊 Logs Directory](#-logs-directory)
- [🛣️ Routes Index](#️-routes-index)
- [🔧 Configuration](#-configuration)
- [📝 Usage Examples](#-usage-examples)

---

## 📊 **Logs Directory**

### **Purpose**
The `logs/` directory contains runtime logs and access data generated by Citadel during operation.

### **Directory Structure**
```
logs/
├── 📄 access.sample.ndjson   # Sample access log format
└── 📁 [runtime logs]         # Generated during operation (git-ignored)
```

### **Log Format (NDJSON)**
```json
{"timestamp":"2025-10-29T11:49:00.000Z","method":"GET","path":"/api/validate","status":200,"duration":12,"userAgent":"Citadel/1.15"}
```

### **Configuration**
```bash
# Environment variables for logging
LOG_LEVEL=info                # debug, info, warn, error
LOG_FORMAT=ndjson             # ndjson, json, text
LOG_ROTATION=daily            # daily, weekly, monthly
LOG_RETENTION=30              # Days to retain logs
```

### **Log Analysis Commands**
```bash
# View latest logs
tail -f logs/access.ndjson

# Count requests by endpoint
cat logs/access.ndjson | jq -r '.path' | sort | uniq -c | sort -nr

# Average response time
cat logs/access.ndjson | jq -r '.duration' | awk '{sum+=$1; count++} END {print sum/count}'

# Error rate calculation
total=$(cat logs/access.ndjson | wc -l)
errors=$(cat logs/access.ndjson | jq -r '.status' | grep -c '5[0-9][0-9]')
echo "scale=2; $errors/$total*100" | bc
```

---

## 🛣️ Routes Index

### **Purpose**
The `.routes.index` file contains a list of all API route handlers that export `handle` functions, used for automatic API discovery and documentation generation.

### **Current Routes**
```
# AI-Generated Routes (5 suggestions):
routes/ai/suggestion-0.ts    # /api/v1/users/audit (97.3% confidence)
routes/ai/suggestion-1.ts    # /api/v1/analytics/export (95.8% confidence)
routes/ai/suggestion-2.ts    # /api/v1/dashboard/metrics (94.2% confidence)
routes/ai/suggestion-3.ts    # /api/v1/config/toggle (93.7% confidence)
routes/ai/suggestion-4.ts    # /api/v1/reports/generate (92.1% confidence)

# Core Configuration Routes:
routes/config/store.ts       # Configuration storage API
routes/ws/config-broadcast.ts # WebSocket configuration broadcasting
routes/config/validate.ts    # Configuration validation API
routes/config/get-by-hash.ts # Configuration retrieval by hash
```

### **Route Categories**

| Route | Method | Purpose | Handler | Type |
|-------|--------|---------|---------|------|
| `/api/v1/users/audit` | GET | User audit endpoint | `routes/ai/suggestion-0.ts` | AI-Generated |
| `/api/v1/analytics/export` | GET | Analytics data export | `routes/ai/suggestion-1.ts` | AI-Generated |
| `/api/v1/dashboard/metrics` | GET | Dashboard metrics API | `routes/ai/suggestion-2.ts` | AI-Generated |
| `/api/v1/config/toggle` | POST | Configuration toggle | `routes/ai/suggestion-3.ts` | AI-Generated |
| `/api/v1/reports/generate` | POST | Report generation | `routes/ai/suggestion-4.ts` | AI-Generated |
| `/api/config` | POST | Store configuration | `routes/config/store.ts` | Core |
| `/ws/config` | WS | Broadcast config changes | `routes/ws/config-broadcast.ts` | Core |
| `/api/config/validate` | POST | Validate configuration | `routes/config/validate.ts` | Core |
| `/api/config/:hash` | GET | Get config by hash | `routes/config/get-by-hash.ts` | Core |

### **Regenerating Routes Index**
```bash
# Regenerate with current route handlers
bun run api:index

# Manual regeneration
rg --files-with-matches 'export const handle' routes/ > .routes.index
```

### **AI Route Suggestion Generation**
```bash
# Generate AI-suggested routes from usage patterns
bun run scripts/ai-suggest.ts

# Dry-run mode (no file changes)
AI_HANDLER_WRITE=false bun run scripts/ai-suggest.ts

# Generate OpenAPI schemas with AI routes
bun run scripts/gen-openapi-schemas.ts
```

**AI Suggestion Process:**
1. **Log Analysis** - Analyzes usage logs for patterns
2. **Vector Embedding** - Creates 384-dim embeddings using sentence-transformers
3. **Confidence Scoring** - Rates suggestions by confidence (90%+ threshold)
4. **Schema Generation** - Auto-generates Zod schemas and TypeScript handlers
5. **OpenAPI Integration** - Updates OpenAPI spec with AI-generated schemas

**AI-Generated Features:**
- ✅ **Type-safe schemas** with Zod validation
- ✅ **UUID-based resource IDs** for enterprise compatibility
- ✅ **Confidence scoring** for transparency
- ✅ **AI metadata headers** in responses
- ✅ **Backup files** for safe regeneration
- ✅ **OpenAPI integration** for automatic documentation

---

## 🔧 **Configuration**

### **Environment Variables**
```bash
# API Configuration
API_PORT=3000                  # API server port
API_HOST=localhost             # API server host
API_TIMEOUT=30000              # Request timeout (ms)

# Logging Configuration
LOG_LEVEL=info                 # Log level
LOG_FORMAT=ndjson              # Log format
LOG_ROTATION=daily             # Log rotation frequency
LOG_RETENTION=30               # Log retention period (days)
```

### **Route Discovery**
```bash
# Discover all API routes
bun run api:grep

# Generate OpenAPI schemas
bun run api:gen

# Validate API routes
bun run api:validate
```

---

## 📝 **Usage Examples**

### **Monitoring API Usage**
```bash
# Start API server with logging
bun run api:serve

# Monitor logs in real-time
tail -f logs/access.ndjson | jq '.'

# Generate analytics report
bun run scripts/repo-analytics.ts --source logs/
```

### **Route Development**
```bash
# Create new route
echo 'export const handle = async (req) => new Response("Hello");' > routes/new-endpoint.ts

# Regenerate routes index
bun run api:index

# Validate new route
bun run api:validate
```

### **Log Analysis**
```bash
# Filter errors
grep '"status":5[0-9][0-9]' logs/access.ndjson

# Performance analysis
cat logs/access.ndjson | jq -r 'select(.duration > 100)'

# User agent analysis
cat logs/access.ndjson | jq -r '.userAgent' | sort | uniq -c
```

---

## 📚 **Related Documentation**

- **[API Documentation](../08-api-reference/)** - Complete API reference
- **[Configuration Guide](../09-configuration/)** - Configuration options
- **[Enterprise Analytics](../scripts/enterprise-analytics.ts)** - Log analysis tools
- **[Security Documentation](../03-quantum-security/)** - Log security and privacy

---

*Last updated: v1.15-env-locked*
